<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recompensas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../src/footer.css">
    <link rel="stylesheet" href="../src/index.css">
    <link rel="stylesheet" href="../src/nav.css">
    <style>


    </style>
    </head>
<body>
<nav class="navbar">
    <!-- Secci√≥n Izquierda: Logo -->
    <div class="navbar-logo">
        <img src="../assets/img/logo.png" alt="Logo de TakumiNet">
    </div>

    <!-- Secci√≥n Central: Enlaces de navegaci√≥n -->
    <ul class="nav-links">
      <li><a href="index.html" class="active" aria-current="page"><i class="fas fa-home"></i> <span data-i18n="inicio">Inicio</span></a></li>
      <li><a href="marketplace.html"><i class="fas fa-store"></i> <span data-i18n="tienda">Tienda</span></a></li>
      <li><a href="game jam.html"><i class="fas fa-calendar-alt"></i> <span data-i18n="game_jams">Game Jams</span></a></li>
      <li><a href="centro-aprendiz.html"><i class="fas fa-graduation-cap"></i> <span data-i18n="tutoriales">Tutoriales</span></a></li>
      <li><a href="ranking.html"><i class="fas fa-newspaper"></i> <span data-i18n="Noticias">Noticias</span></a></li>
      <li><a href="comunidad.html"><i class="fas fa-users"></i> <span data-i18n="comunidad">Comunidad</span></a></li>
    </ul>

    <!-- Secci√≥n Derecha: Elementos interactivos -->
    <div class="nav-right">
      <!-- B√∫squeda -->
      <form class="search-box" role="search">
        <input type="search" class="search-input" placeholder="Buscar juegos, usuarios..." aria-label="Buscar en el sitio" data-i18n="buscar" data-i18n-type="placeholder">
        <button type="submit" class="search-btn" aria-label="Ejecutar b√∫squeda">
          <i class="fas fa-search"></i>
        </button>
      </form>

      <!-- Iconos de notificaciones -->
      <div class="nav-icons">
        <div class="notification-wrapper">
          <button class="icon-btn notification-btn" onclick="toggleNotifications()" aria-haspopup="true" aria-expanded="false" aria-label="Notificaciones">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge" aria-live="polite">0</span>
          </button>

          <!-- Men√∫ desplegable de notificaciones -->
          <div class="dropdown-menu notification-dropdown" id="notificationDropdown" role="menu" aria-hidden="true" style="display:none;">
            <div class="dropdown-header">
              <h4 class="dropdown-title" data-i18n="notificaciones">Notificaciones</h4>
              <button class="mark-read" id="markReadBtn" data-i18n="ver_todas">Marcar todas como le√≠das</button>
            </div>

            <div class="notifications-list" id="notificationsList">
              <!-- Aqu√≠ se insertar√°n las notificaciones din√°micamente -->
            </div>
            <div class="dropdown-footer">
              <a href="/notificaciones" class="view-all" data-i18n="ver_todas">Ver todas</a>
            </div>
          </div>
        </div>

        <!-- Carrito de compras -->
        <div class="icon-btn cart-btn" aria-label="Carrito de compras" role="button" tabindex="0" onclick="toggleCart()">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-badge" aria-live="polite">5</span>
        </div>

        <!-- Men√∫ de usuario -->
        <div class="user-menu">
          <button class="user-profile" aria-haspopup="true" aria-expanded="false" onclick="toggleUserMenu()">
            <div class="avatar">
              <i class="fas fa-user"></i>
            </div>
            <span class="username" id="mostrarNombre">Invitado</span>
          </button>

          <!-- Men√∫ desplegable de usuario -->
          <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
            <div class="dropdown-group">
              <a href="perfil del usuario.html" class="menu-item"><i class="fas fa-user"></i><span data-i18n="perfil">Perfil</span></a>
              <a href="mis juegos.html" class="menu-item"><i class="fas fa-gamepad"></i><span data-i18n="mis_juegos">Mis Juegos</span></a>
              <a href="juegos favoritos.html" class="menu-item"><i class="fas fa-heart"></i><span data-i18n="favoritos">Favoritos</span></a>
              <a href="Creator Dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i><span data-i18n="dashboard">Dashboard</span></a>
              <a href="subir_juegos.html" class="menu-item"><i class="fas fa-upload"></i><span data-i18n="subir_juego">Subir Juego</span></a>
            </div>
            <div class="dropdown-group">
              <a href="biblioteca.html" class="menu-item"><i class="fas fa-book"></i><span data-i18n="biblioteca">Biblioteca</span></a>
              <a href="descarga.html" class="menu-item"><i class="fas fa-download"></i><span data-i18n="descargas">Descargas</span></a>
            </div>
            <hr class="divider">
            <div class="dropdown-group">
              <a href="configuracion.html" class="menu-item"><i class="fas fa-cog"></i><span data-i18n="configuracion">Configuraci√≥n</span></a>
              <a href="perfil-editar.html" class="menu-item"><i class="fas fa-user-edit"></i><span data-i18n="editar_usuario">Editar Usuario</span></a>
                <a href="pagos-desarrollador.html" class="menu-item"><i class="fas fa-money-bill-wave"></i><span data-i18n="pagos">Pagos</span></a>
              <a href="seguidos.html" class="menu-item"><i class="fas fa-heart"></i><span data-i18n="seguidos">Seguidos</span></a>
            </div>
            <hr class="divider">
            <div class="dropdown-group">
              <button class="menu-item logout"><i class="fas fa-sign-out-alt"></i><span data-i18n="cerrar_sesion">Cerrar Sesi√≥n</span></button>
            </div>
          </div>
        </div>
      </div>
    </div>
</nav>



<main class="noticias-container">
    <!-- T√≠tulo -->
      <h1 class="titulo-seccion" data-i18n="news.title">üïπÔ∏è Noticias de Videojuegos</h1>

    <!-- Contenedor para noticias -->
    <section id="lista-noticias">
      <p data-i18n="news.loading">Cargando noticias...</p>
    </section>
  </main>


<footer class="noticia-footer">
  <p>
    <span class="icono-alerta">üì¢</span>
    Las noticias mostradas son obtenidas desde 
    <a href="https://www.3djuegos.com" target="_blank" rel="noopener noreferrer">3DJuegos.com</a> 
    mediante RSS, con fines informativos y enlazando siempre al sitio original.
  </p>
</footer>


<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

</section>
<script src="../js/notificacion.js"></script>
<script src="../js/carrito.js"></script>
<script src="../js/user.js"></script>
<script src="../js/desplegar.js"></script>
<script src="../js/cerrar sesion.js"></script>
<script src="../js/i18n.js"></script>
<script src="../js/usario.js"></script>


        </body>
    </head>
</html>


<script>
  document.addEventListener('DOMContentLoaded', function() {
  // Configuraci√≥n mejorada
  const config = {
    newsPerPage: 6,
    updateInterval: 300000, // 5 minutos
    rssUrl: 'https://vandal.elespanol.com/xml.cgi',
    currentPage: 1,
    totalItems: 0,
    allItems: [],
    lastUpdated: null,
    cacheDuration: 60000 // 1 minuto de cach√©
  };

  const newsContainer = document.getElementById('lista-noticias');
  const paginationContainer = document.createElement('div');
  paginationContainer.className = 'pagination';
  newsContainer.after(paginationContainer);

  // Estado de carga
  let isLoading = false;

  // Cargar noticias inicialmente
  loadNews();

  // Actualizaci√≥n peri√≥dica
  const updateTimer = setInterval(loadNews, config.updateInterval);

  // Funci√≥n principal mejorada
  async function loadNews() {
    if (isLoading) return;
    
    // Verificar cach√©
    if (config.lastUpdated && (Date.now() - config.lastUpdated < config.cacheDuration)) {
      renderNews();
      renderPagination();
      return;
    }

    isLoading = true;
    showLoadingState();

    try {
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(config.rssUrl)}`;
      
      const response = await fetchWithTimeout(proxyUrl, {
        timeout: 10000 // 10 segundos timeout
      });

      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

      const data = await response.json();
      
      if (!data.contents || data.contents.trim() === '') {
        throw new Error('El feed RSS est√° vac√≠o o no contiene datos v√°lidos');
      }

      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(data.contents, 'text/xml');
      
      // Verificar si el parseo fue correcto
      const errorNode = xmlDoc.querySelector('parsererror');
      if (errorNode) {
        throw new Error('Error al parsear el XML del feed RSS');
      }

      config.allItems = Array.from(xmlDoc.querySelectorAll('item'));
      config.totalItems = config.allItems.length;
      config.lastUpdated = Date.now();
      
      renderNews();
      renderPagination();
    } catch (error) {
      console.error('Error al cargar noticias:', error);
      showErrorState(error);
    } finally {
      isLoading = false;
    }
  }

  // Funci√≥n fetch con timeout
  function fetchWithTimeout(resource, options = {}) {
    const { timeout = 8000 } = options;
    
    const controller = new AbortController();
    const id = setTimeout(() => controller.abort(), timeout);
    
    return fetch(resource, {
      ...options,
      signal: controller.signal
    }).then(response => {
      clearTimeout(id);
      return response;
    }).catch(error => {
      clearTimeout(id);
      throw error;
    });
  }

  // Mostrar estado de carga
  function showLoadingState() {
    newsContainer.innerHTML = `
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Cargando las √∫ltimas noticias...</p>
      </div>
    `;
  }

  // Mostrar estado de error
  function showErrorState(error) {
    newsContainer.innerHTML = `
      <div class="error-state">
        <span class="error-icon">‚ö†Ô∏è</span>
        <h3>No se pudieron cargar las noticias</h3>
        <p>${error.message || 'Error desconocido'}</p>
        <button onclick="location.reload()" class="retry-btn">Reintentar</button>
        <p class="small">√öltima actualizaci√≥n: ${config.lastUpdated ? new Date(config.lastUpdated).toLocaleTimeString() : 'Nunca'}</p>
      </div>
    `;
  }

  // Renderizar noticias (optimizado)
  function renderNews() {
    const start = (config.currentPage - 1) * config.newsPerPage;
    const end = start + config.newsPerPage;
    const itemsToShow = config.allItems.slice(start, end);

    const newsHTML = itemsToShow.map(item => {
      const title = sanitizeHTML(item.querySelector('title')?.textContent || 'Sin t√≠tulo');
      const link = sanitizeHTML(item.querySelector('link')?.textContent || '#');
      const description = item.querySelector('description')?.textContent || '';
      const pubDate = item.querySelector('pubDate')?.textContent || '';
      const imageUrl = extractImageUrl(description);

      return `
        <article class="noticia-card">
          ${imageUrl ? `<img src="${imageUrl}" alt="${title}" class="noticia-imagen" loading="lazy">` : ''}
          <div class="noticia-contenido">
            <h3><a href="${link}" target="_blank" rel="noopener noreferrer">${title}</a></h3>
            <time datetime="${pubDate}">${formatDate(pubDate)}</time>
            <p>${cleanDescription(description)}</p>
            <a href="${link}" target="_blank" rel="noopener noreferrer" class="leer-mas">Leer m√°s</a>
          </div>
        </article>
      `;
    }).join('');

    newsContainer.innerHTML = `<div class="noticias-grid">${newsHTML}</div>`;
  }

  // Renderizar paginaci√≥n (optimizado)
  function renderPagination() {
    const totalPages = Math.ceil(config.totalItems / config.newsPerPage);
    
    if (totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    const prevBtn = `
      <button class="page-btn ${config.currentPage === 1 ? 'disabled' : ''}" 
        onclick="changePage(${config.currentPage - 1})" ${config.currentPage === 1 ? 'disabled' : ''}>
        &laquo; Anterior
      </button>
    `;

    const nextBtn = `
      <button class="page-btn ${config.currentPage === totalPages ? 'disabled' : ''}" 
        onclick="changePage(${config.currentPage + 1})" ${config.currentPage === totalPages ? 'disabled' : ''}>
        Siguiente &raquo;
      </button>
    `;

    let pageBtns = '';
    const maxVisiblePages = 5;
    let startPage = Math.max(1, config.currentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      pageBtns += `<button class="page-btn" onclick="changePage(1)">1</button>`;
      if (startPage > 2) pageBtns += `<span class="page-dots">...</span>`;
    }

    for (let i = startPage; i <= endPage; i++) {
      pageBtns += `<button class="page-btn ${i === config.currentPage ? 'active' : ''}" 
        onclick="changePage(${i})">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) pageBtns += `<span class="page-dots">...</span>`;
      pageBtns += `<button class="page-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
    }

    paginationContainer.innerHTML = prevBtn + pageBtns + nextBtn;
  }

  // Funci√≥n para sanitizar HTML
  function sanitizeHTML(str) {
    const temp = document.createElement('div');
    temp.textContent = str;
    return temp.innerHTML;
  }

  // Funci√≥n global para cambiar p√°gina
  window.changePage = function(newPage) {
    if (newPage < 1 || newPage > Math.ceil(config.totalItems / config.newsPerPage)) return;
    config.currentPage = newPage;
    renderNews();
    renderPagination();
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // Actualizar URL sin recargar
    history.pushState({ page: newPage }, `P√°gina ${newPage}`, `?page=${newPage}`);
  };

  // Manejar navegaci√≥n atr√°s/adelante
  window.addEventListener('popstate', function(event) {
    const urlParams = new URLSearchParams(window.location.search);
    const page = parseInt(urlParams.get('page')) || 1;
    if (page !== config.currentPage) {
      config.currentPage = page;
      renderNews();
      renderPagination();
    }
  });

  // Cargar p√°gina desde URL al inicio
  const urlParams = new URLSearchParams(window.location.search);
  const initialPage = parseInt(urlParams.get('page')) || 1;
  if (initialPage !== 1) {
    config.currentPage = initialPage;
  }
});

// Funci√≥n para extraer imagen (mejorada)
function extractImageUrl(description) {
  if (!description) return null;
  
  // Primero intentar con src normal
  const imgRegex = /<img[^>]+src=["']([^"'>]+)["']/i;
  let match = description.match(imgRegex);
  
  // Si no encuentra, intentar con data-src (im√°genes lazy)
  if (!match) {
    const dataSrcRegex = /<img[^>]+data-src=["']([^"'>]+)["']/i;
    match = description.match(dataSrcRegex);
  }
  
  // Si sigue sin encontrar, buscar URLs que parezcan im√°genes
  if (!match) {
    const urlRegex = /(https?:\/\/[^\s"']+\.(jpg|jpeg|png|gif|webp))/i;
    match = description.match(urlRegex);
  }
  
  return match ? match[1] : 'https://via.placeholder.com/300x150?text=3DJuegos';
}

// Funci√≥n para limpiar descripci√≥n (mejorada)
function cleanDescription(desc) {
  if (!desc) return '';
  
  // Eliminar etiquetas HTML
  const div = document.createElement('div');
  div.innerHTML = desc;
  let text = div.textContent || div.innerText || '';
  
  // Limpiar espacios y saltos de l√≠nea
  text = text.replace(/\s+/g, ' ').trim();
  
  // Recortar y a√±adir puntos suspensivos si es necesario
  return text.length > 120 ? text.substring(0, 120) + '...' : text;
}

// Funci√≥n para formatear fecha (mejorada)
function formatDate(dateString) {
  if (!dateString) return '';
  
  try {
    const date = new Date(dateString);
    if (isNaN(date.getTime())) throw new Error('Fecha inv√°lida');
    
    const options = {
      day: 'numeric',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    };
    
    return date.toLocaleDateString('es-ES', options);
  } catch (e) {
    console.warn('Error al formatear fecha:', e);
    return dateString; // Devolver el string original si falla el parseo
  }
}
</script>