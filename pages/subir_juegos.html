<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sube tu Juego - TakumiNet</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../src/index.css">
    <link rel="stylesheet" href="../src/nav.css">
    <link rel="stylesheet" href="../src/subirjuegos.css">
<style>

/* Configuración de la barra de navegación */
.config-navbar {
    display: flex;
    align-items: center;
    justify-content: start;
    padding: 1rem 2rem;
    background-color: #1B1B1B; /* Fondo oscuro profesional */
    color: #ffffff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    gap: 1rem;
    border-bottom: 2px solid #00ff0d; /* Línea morada decorativa */
}

.back-btn {
    color: #ffffff;
    font-size: 1.5rem;
    text-decoration: none;
    transition: color 0.3s ease;
}

.back-btn:hover {
    color: #17ff02; /* Morado hover */
}

.config-title {
    font-size: 1.4rem;
    font-weight: 600;
    margin: 0;
    color: #f3f4f6;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}




/* Contenedor de las opciones */
.storage-options {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    justify-content: center; /* Centra las opciones */
    margin-top: 15px;
}

/* Cada opción individual */
.storage-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 120px;
    padding: 15px;
    border: 2px solid #ddd;
    border-radius: 12px;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    text-align: center;
}

/* Imagen del logo */
.storage-option img.storage-logo {
    width: 48px;
    height: 48px;
    margin-bottom: 8px;
    transition: transform 0.3s ease;
}

/* Texto debajo del logo */
.storage-option div {
    font-weight: 600;
    color: #333;
    font-size: 14px;
}

/* Hover con animación */
.storage-option:hover {
    transform: translateY(-5px) scale(1.05);
    border-color: #999;
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

.storage-option:hover img.storage-logo {
    transform: scale(1.2) rotate(10deg);
}

/* Opción seleccionada */
.storage-option.selected {
    border-color: #007BFF;
    box-shadow: 0 6px 15px rgba(0,123,255,0.3);
}



/* Modal general */
.modal {
  display: none; /* Oculto por defecto */
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente */
  backdrop-filter: blur(3px); /* Suaviza el fondo */
  transition: opacity 0.3s ease;
}

/* Contenido del modal */
.modal-content {
  background-color: #1e1e2f; /* Color oscuro moderno */
  margin: 10% auto; /* Centrado vertical */
  padding: 25px 20px;
  border-radius: 15px;
  width: 350px;
  max-width: 90%;
  text-align: center;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  animation: slideDown 0.3s ease;
  color: #f1f1f1;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Animación al aparecer */
@keyframes slideDown {
  from { transform: translateY(-30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Botón cerrar */
.close {
  color: #bbb;
  float: right;
  font-size: 24px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.2s ease;
}
.close:hover {
  color: #ff4d4d;
}

/* Título del modal */
.modal-content h3 {
  margin-top: 0;
  margin-bottom: 15px;
  font-size: 1.3rem;
  color: #fff;
}

/* Input de URL */
#mediafire-url {
  width: 100%;
  padding: 10px 12px;
  margin-bottom: 18px;
  border-radius: 10px;
  border: 1px solid #555;
  background-color: #2b2b3c;
  color: #fff;
  font-size: 0.95rem;
  transition: border-color 0.2s ease;
}
#mediafire-url:focus {
  outline: none;
  border-color: #05f010;
}

/* Botón agregar enlace */
.modal-content button {
  width: 100%;
  padding: 10px 0;
  border: none;
  background-color: #05f010;
  color: #fff;
  font-size: 1rem;
  font-weight: 600;
  border-radius: 10px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.2s ease;
}
.modal-content button:hover {
  background-color: #03b10a;
  transform: translateY(-2px);
}

</style>

<nav class="config-navbar">
    <!-- Botón Volver -->
    <a href="Creator Dashboard.html" class="back-btn" title="Volver al Inicio" data-i18n-title="config.backToHome">
        <i class="fas fa-arrow-left"></i>
    </a>
    <!-- Título -->
    <h1 class="config-title" data-i18n="config.return">Volver</h1>
</nav>


<form action="http://localhost:3001/api/juegos" method="post" enctype="multipart/form-data" class="upload-form">
  <div class="upload-container">

    <!-- Sección Título -->
    <div class="form-group">
      <label for="title" class="form-label">Título del juego</label>
      <input type="text" id="title" name="title" class="form-input" required placeholder="Escribe el título">
    </div>

    <!-- Sección Usuario -->
    <div class="form-group user-section">
      <div class="domain-wrapper">
        <div class="domain" id="user-domain">Usuario</div>
      </div>
      <p class="user-info">
        Nombre del propietario: <strong><span id="username">usuario</span></strong><br>
        ID del usuario: <strong><span id="user-id-display">cargando...</span></strong>
      </p>
      <input type="hidden" id="user-id" name="user_id" value="0">
    </div>

    <!-- Sección Descripción -->
    <div class="form-group">
      <label for="description" class="form-label">Descripción</label>
      <textarea id="description" name="description" class="form-textarea" required placeholder="Escribe una descripción"></textarea>
    </div>

    <!-- Sección Categoría -->
    <div class="form-group">
      <label for="category" class="form-label">Categoría</label>
      <select id="category" name="category" class="form-select" required>
        <option value="aventura">Aventura</option>
        <option value="rpg">RPG</option>
        <option value="acción">Acción</option>
        <option value="puzzle">Puzzle</option>
        <option value="terror">Terror</option>
        <option value="otro">Otro</option>
      </select>
    </div>

    <!-- Sección Géneros -->
    <div class="form-group">
      <label for="genres" class="form-label">Géneros</label>
      <select id="genres" name="genres" class="form-select" required>
        <option value="pixelart">Pixelart</option>
        <option value="retro">Retro</option>
        <option value="historia-corta">Historia corta</option>
        <option value="comedia">Comedia</option>
        <option value="fantasía">Fantasía</option>
        <option value="niveles">Niveles</option>
        <option value="decisiones">Decisiones</option>
        <option value="magia">Magia</option>
        <option value="puzzles">Puzzles</option>
        <option value="2D">2D</option>
        <option value="3D">3D</option>
        <option value="4K">4K</option>
        <option value="cooperativo">Cooperativo</option>
        <option value="competitivo">Competitivo</option>
        <option value="enemigos">Enemigos</option>
        <option value="jefes">Jefes</option>
        <option value="minijuegos">Minijuegos</option>
        <option value="sin-texto">Sin texto</option>
        <option value="misterio">Misterio</option>
        <option value="cyberpunk">Cyberpunk</option>
        <option value="anime">Anime</option>
      </select>
    </div>

    <!-- Sección Género Principal -->
    <div class="form-group">
      <label for="main_genre" class="form-label">Género Principal</label>
      <select id="main_genre" name="main_genre" class="form-select" required>
        <option value="no-genero">No género</option>
        <option value="aventura">Aventura</option>
        <option value="rpg">RPG</option>
        <option value="acción">Acción</option>
        <option value="puzzle">Puzzle</option>
        <option value="terror">Terror</option>
        <option value="otro">Otro</option>
      </select>
    </div>

    <!-- Sección Requisitos -->
    <fieldset class="form-fieldset">
      <legend class="form-legend">Requisitos del Sistema</legend>
      <div class="form-group">
        <label for="tipo-requisitos"><strong>Selecciona el tipo de requisitos:</strong></label>
        <select id="tipo-requisitos" class="form-select" onchange="mostrarFormulario()">
          <option value="">-- Selecciona una opción --</option>
          <option value="minimos">Requisitos Mínimos</option>
          <option value="recomendados">Requisitos Recomendados</option>
        </select>
      </div>

      <div id="form-minimos" class="requirements-form" style="display: none;">
        <h3>Requisitos Mínimos</h3>
        <input type="text" id="min_os" name="min_os" class="form-input" placeholder="Sistema Operativo">
        <input type="text" id="min_cpu" name="min_cpu" class="form-input" placeholder="Procesador">
        <input type="text" id="min_ram" name="min_ram" class="form-input" placeholder="Memoria RAM">
        <input type="text" id="min_gpu" name="min_gpu" class="form-input" placeholder="Tarjeta Gráfica">
        <input type="text" id="min_storage" name="min_storage" class="form-input" placeholder="Almacenamiento">
      </div>

      <div id="form-recomendados" class="requirements-form" style="display: none;">
        <h3>Requisitos Recomendados</h3>
        <input type="text" id="rec_os" name="rec_os" class="form-input" placeholder="Sistema Operativo">
        <input type="text" id="rec_cpu" name="rec_cpu" class="form-input" placeholder="Procesador">
        <input type="text" id="rec_ram" name="rec_ram" class="form-input" placeholder="Memoria RAM">
        <input type="text" id="rec_gpu" name="rec_gpu" class="form-input" placeholder="Tarjeta Gráfica">
        <input type="text" id="rec_storage" name="rec_storage" class="form-input" placeholder="Almacenamiento">
      </div>
    </fieldset>

    <!-- Sección Portada del Juego -->
    <div class="form-group">
      <label for="cover" class="form-label">Imagen destacada del juego</label>
      <input type="file" id="cover" name="cover" class="form-file" accept=".jpg,.jpeg,.png" required>
      <small class="form-text">
        Recomendado: 1280 × 719 px, formato JPG o PNG, máximo 2 MB
      </small>
    </div>

    <div id="preview-container" style="margin-top: 10px; position: relative; width: 640px; max-width: 100%;">
      <img id="cover-preview" src="" alt="Vista previa de portada" style="width: 100%; height: auto; border-radius: 12px; display: none;">
      <button id="remove-cover" style="position: absolute; top: 10px; right: 10px; background: red; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; display: none; font-weight: bold;">X</button>
    </div>

    <!-- Sección Capturas -->
    <div class="form-group">
      <label for="screenshots" class="form-label">Capturas del juego (mínimo 5)</label>
      <input type="file" id="screenshots" name="screenshots" class="form-file" accept=".jpg,.jpeg,.png,.gif" multiple required>
    </div>

    <!-- Sección Video -->
    <div class="form-group">
      <label for="youtube_url" class="form-label">URL del video del juego</label>
      <input type="url" id="youtube_url" name="youtube_url" class="form-input" placeholder="https://www.youtube.com/watch?v=XXXXX">
    </div>

<!-- Sección Archivo del juego -->
<div class="form-group">
  <label for="game_file" class="form-label">
    Archivo del juego (ZIP)
  </label>
  <input type="file" id="game_file" name="game_file" class="form-file" accept=".zip">
  <small class="form-text">
    ⚠️ Archivos hasta 1 GB se pueden subir directamente. <br>
  </small>
</div>

<!-- Sección Almacenamiento Externo -->
<div class="form-group">
  <label class="form-label">Selecciona dónde se alojará tu juego:</label>
  <small>⚠️Archivos mayores a 1 GB (hasta 5 GB) usa Google Drive, Dropbox o MediaFire.</small>
  <div class="storage-options">
    <!-- MediaFire -->
    <div class="storage-option" data-service="mediafire" onclick="openMediaFireModal()">
      <img src="https://play-lh.googleusercontent.com/YCYtU9DwQDIX1QbDDqF8sQU1CKlWABF-Sbtr3qH_9z9MJ495HsXNe4KkfxFycK9FyAI" 
           alt="MediaFire" width="48" height="48" class="storage-logo">
      <div>MediaFire</div>
      <input type="hidden" id="mediafire-link" name="mediafire_link">
    </div>
  </div>
</div>

<input type="hidden" id="storage-service" name="storage_service" value="">

<!-- Modal MediaFire -->
<div id="mediafire-modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeMediaFireModal()">&times;</span>
    <h3>Agregar enlace de MediaFire</h3>
    <input type="url" id="mediafire-url" placeholder="Pega el enlace ZIP aquí">
    <button onclick="saveMediaFireLink()">Agregar enlace</button>
  </div>
</div>


    <!-- Sección Precio -->
    <div class="form-group">
      <label for="pricing" class="form-label">Precio</label>
      <select id="pricing" name="pricing" class="form-select" required>
        <option value="gratis">Gratis</option>
        <option value="pago">Pago</option>
        <option value="donacion">Donación</option>
      </select>
      <input type="number" id="price" name="price" class="form-input" min="0" step="0.01" placeholder="0.00" style="display:none;">
    </div>

    <!-- Términos -->
    <div class="form-group terms-group">
      <input type="checkbox" id="terms" name="terms" class="form-checkbox" required>
      <label for="terms" class="form-label">
        Normas y Pagos de TakumiNet
        <a href="../pdf/TakumiNet_Terminos_y_Condiciones.pdf" download class="terms-link" target="_blank">Ver Normas y Pagos</a>
      </label>
    </div>

    <!-- Botón de Publicar -->
    <div class="form-group">
      <button type="button" class="btn-submit" onclick="subirJuego()">
        <i class="fas fa-cloud-upload-alt"></i> Publicar Juego
      </button>
    </div>

  </div>
</form>

<script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
<script src="../js/userid.js"></script>
<script src="../preload.js"></script>
<script src="../js/usario.js"></script>
<script src="../js/Nombres.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aws-sdk@2.1482.0/dist/aws-sdk.min.js"></script>
<script src="../autoSync.js"></script>

<script src="https://apis.google.com/js/api.js"></script>

<script>
// ========== INICIALIZACIÓN ==========
document.addEventListener('DOMContentLoaded', function() {
  inicializarEventListeners();
  cargarDatosUsuario();
});

function cargarDatosUsuario() {
  // Intentar obtener datos del usuario desde localStorage o otras fuentes
  const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
  const userId = localStorage.getItem('userId');
  
  if (usuario && usuario.username) {
    const usernameElement = document.getElementById('username');
    const userIdDisplayElement = document.getElementById('user-id-display');
    const userIdInputElement = document.getElementById('user-id');
    
    if (usernameElement) usernameElement.textContent = usuario.username;
    if (userIdDisplayElement && userId) userIdDisplayElement.textContent = userId;
    if (userIdInputElement && userId) userIdInputElement.value = userId;
  }
}

function inicializarEventListeners() {
  // Precio dinámico
  const pricingElement = document.getElementById('pricing');
  if (pricingElement) {
    pricingElement.addEventListener('change', togglePrecioInput);
  }
  
  // Vista previa de portada
  const coverElement = document.getElementById('cover');
  if (coverElement) {
    coverElement.addEventListener('change', mostrarVistaPreviaPortada);
  }
  
  const removeCoverElement = document.getElementById('remove-cover');
  if (removeCoverElement) {
    removeCoverElement.addEventListener('click', eliminarVistaPreviaPortada);
  }
  
  // Modal MediaFire
  const closeModalElement = document.querySelector('.close');
  if (closeModalElement) {
    closeModalElement.addEventListener('click', cerrarModalMediaFire);
  }
  
  const mediafireModal = document.getElementById('mediafire-modal');
  if (mediafireModal) {
    mediafireModal.addEventListener('click', function(e) {
      if (e.target === this) cerrarModalMediaFire();
    });
  }
  
  // Formulario de requisitos
  const tipoRequisitos = document.getElementById('tipo-requisitos');
  if (tipoRequisitos) {
    tipoRequisitos.addEventListener('change', mostrarFormularioRequisitos);
  }
  
  // Botón de envío
  const submitButton = document.querySelector('.btn-submit');
  if (submitButton) {
    submitButton.addEventListener('click', function(e) {
      e.preventDefault();
      subirJuego();
    });
  }
  
  // Botón de MediaFire
  const mediafireButton = document.getElementById('save-mediafire');
  if (mediafireButton) {
    mediafireButton.addEventListener('click', guardarEnlaceMediaFire);
  }
  
  // Opción de almacenamiento MediaFire
  const mediafireOption = document.querySelector('.storage-option[data-service="mediafire"]');
  if (mediafireOption) {
    mediafireOption.addEventListener('click', function() {
      seleccionarOpcionAlmacenamiento(this);
    });
  }
}

// ========== FUNCIONES DE INTERFAZ ==========
function togglePrecioInput() {
  const tipoPrecio = this.value;
  const priceInput = document.getElementById('price');
  if (priceInput) {
    priceInput.style.display = tipoPrecio === 'pago' ? 'block' : 'none';
    if (tipoPrecio !== 'pago') priceInput.value = '';
  }
}

function mostrarFormularioRequisitos() {
  const tipo = this.value;
  const formMinimos = document.getElementById('form-minimos');
  const formRecomendados = document.getElementById('form-recomendados');
  
  if (formMinimos) {
    formMinimos.style.display = tipo === 'minimos' ? 'block' : 'none';
  }
  
  if (formRecomendados) {
    formRecomendados.style.display = tipo === 'recomendados' ? 'block' : 'none';
  }
}

function mostrarVistaPreviaPortada(event) {
  const archivo = event.target.files[0];
  if (!archivo) return;
  
  const lector = new FileReader();
  const vistaPrevia = document.getElementById('cover-preview');
  const btnEliminar = document.getElementById('remove-cover');
  
  lector.onload = function(e) {
    if (vistaPrevia) {
      vistaPrevia.src = e.target.result;
      vistaPrevia.style.display = 'block';
    }
    
    if (btnEliminar) {
      btnEliminar.style.display = 'block';
    }
  };
  
  lector.readAsDataURL(archivo);
}

function eliminarVistaPreviaPortada() {
  const coverInput = document.getElementById('cover');
  const vistaPrevia = document.getElementById('cover-preview');
  const btnEliminar = document.getElementById('remove-cover');
  
  if (coverInput) coverInput.value = '';
  if (vistaPrevia) {
    vistaPrevia.src = '';
    vistaPrevia.style.display = 'none';
  }
  if (btnEliminar) btnEliminar.style.display = 'none';
}

// ========== ALMACENAMIENTO EXTERNO (SOLO MEDIAFIRE) ==========
function seleccionarOpcionAlmacenamiento(elemento) {
  const servicio = elemento.dataset.service;
  const storageServiceInput = document.getElementById('storage-service');
  
  if (storageServiceInput) {
    storageServiceInput.value = servicio;
  }
  
  // Quitar selección anterior
  document.querySelectorAll('.storage-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  // Marcar como seleccionado
  elemento.classList.add('selected');
  
  // Ejecutar acción según servicio (solo MediaFire)
  if (servicio === 'mediafire') {
    abrirModalMediaFire();
  }
}

// ----- MediaFire -----
function abrirModalMediaFire() {
  const modal = document.getElementById('mediafire-modal');
  if (modal) {
    modal.style.display = 'block';
  }
}

function cerrarModalMediaFire() {
  const modal = document.getElementById('mediafire-modal');
  if (modal) {
    modal.style.display = 'none';
  }
}

function guardarEnlaceMediaFire() {
  const urlInput = document.getElementById('mediafire-url');
  const url = urlInput ? urlInput.value.trim() : '';
  
  if (!url) {
    alert('Por favor, ingresa un enlace válido de MediaFire.');
    return;
  }
  
  // Validación mejorada de URL de MediaFire
  if (!url.startsWith('http')) {
    alert('Por favor, ingresa una URL válida (debe comenzar con http o https).');
    return;
  }
  
  // Verificar si es un enlace de MediaFire
  if (!url.includes('mediafire.com')) {
    if (!confirm('Este enlace no parece ser de MediaFire. ¿Estás seguro de que quieres continuar?')) {
      return;
    }
  }
  
  const mediafireLinkInput = document.getElementById('mediafire-link');
  if (mediafireLinkInput) {
    mediafireLinkInput.value = url;
  }
  
  // Actualizar la interfaz para mostrar que MediaFire está seleccionado
  const mediafireOption = document.querySelector('.storage-option[data-service="mediafire"]');
  if (mediafireOption) {
    // Quitar selección anterior
    document.querySelectorAll('.storage-option').forEach(opt => {
      opt.classList.remove('selected');
    });
    
    // Marcar como seleccionado
    mediafireOption.classList.add('selected');
    
    // Actualizar el campo de servicio de almacenamiento
    const storageServiceInput = document.getElementById('storage-service');
    if (storageServiceInput) {
      storageServiceInput.value = 'mediafire';
    }
  }
  
  alert('Enlace de MediaFire guardado correctamente.');
  cerrarModalMediaFire();
}

// ========== VALIDACIÓN Y ENVÍO DEL FORMULARIO ==========
function validarFormulario() {
  // Limpiar errores previos
  limpiarErrores();
  
  let esValido = true;
  
  const titulo = document.getElementById('title') ? document.getElementById('title').value.trim() : '';
  const descripcion = document.getElementById('description') ? document.getElementById('description').value.trim() : '';
  const usuarioId = document.getElementById('user-id') ? document.getElementById('user-id').value : '';
  const portada = document.getElementById('cover') ? document.getElementById('cover').files[0] : null;
  const capturas = document.getElementById('screenshots') ? document.getElementById('screenshots').files : [];
  const terminos = document.getElementById('terms') ? document.getElementById('terms').checked : false;
  
  // Validaciones básicas
  if (!titulo) {
    mostrarError('title', 'Por favor, ingresa un título para el juego.');
    esValido = false;
  }
  
  if (!descripcion) {
    mostrarError('description', 'Por favor, ingresa una descripción para el juego.');
    esValido = false;
  }
  
  if (usuarioId === '0' || !usuarioId) {
    alert('No se ha detectado un usuario válido. Por favor, inicia sesión nuevamente.');
    esValido = false;
  }
  
  if (!portada) {
    mostrarError('cover', 'Debes seleccionar una imagen de portada para el juego.');
    esValido = false;
  }
  
  if (!capturas || capturas.length < 5) {
    mostrarError('screenshots', 'Debes subir al menos 5 capturas de pantalla del juego.');
    esValido = false;
  }
  
  if (!terminos) {
    mostrarError('terms', 'Debes aceptar los términos y condiciones para publicar un juego.');
    esValido = false;
  }
  
  // Validar opción de almacenamiento (solo MediaFire)
  const servicioAlmacenamiento = document.getElementById('storage-service') ? document.getElementById('storage-service').value : '';
  const enlaceMediafire = document.getElementById('mediafire-link') ? document.getElementById('mediafire-link').value : '';
  
  if (!servicioAlmacenamiento) {
    alert('Debes seleccionar MediaFire como opción de almacenamiento para tu juego.');
    esValido = false;
  }
  
  if (servicioAlmacenamiento === 'mediafire' && !enlaceMediafire) {
    alert('Para usar MediaFire, debes proporcionar un enlace válido.');
    esValido = false;
  }
  
  return esValido;
}

function subirJuego() {
  if (!validarFormulario()) return;
  
  const formulario = document.querySelector('.upload-form');
  if (!formulario) return;
  
  const formData = new FormData(formulario);
  const boton = document.querySelector('.btn-submit');
  
  // Deshabilitar botón durante la subida
  if (boton) {
    boton.disabled = true;
    boton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subiendo...';
  }
  
  // URL CORREGIDA: http://localhost:3001/api/juegos
  const url = 'http://localhost:3001/api/juegos?t=' + new Date().getTime();
  
  fetch(url, {
    method: 'POST',
    body: formData,
    headers: {
      'Accept': 'application/json',
    }
  })
  .then(async respuesta => {
    // Verificar si la respuesta es JSON
    const contentType = respuesta.headers.get('content-type');
    if (contentType && contentType.includes('application/json')) {
      const datos = await respuesta.json();
      
      if (!respuesta.ok) {
        throw new Error(datos.message || `Error ${respuesta.status}: ${respuesta.statusText}`);
      }
      
      return datos;
    } else {
      const texto = await respuesta.text();
      if (!respuesta.ok) {
        throw new Error(texto || `Error ${respuesta.status}: ${respuesta.statusText}`);
      }
      
      // Intentar parsear como JSON aunque el header no lo indique
      try {
        return JSON.parse(texto);
      } catch {
        return { message: texto };
      }
    }
  })
  .then(datos => {
    alert('¡Juego subido correctamente!');
    console.log('Respuesta del servidor:', datos);
    
    // Resetear formulario
    formulario.reset();
    
    // Limpiar vista previa
    eliminarVistaPreviaPortada();
    
    // Limpiar selección de almacenamiento
    document.querySelectorAll('.storage-option').forEach(opt => {
      opt.classList.remove('selected');
    });
    document.getElementById('storage-service').value = '';
    document.getElementById('mediafire-link').value = '';
    
    // Redirigir a página de éxito después de 2 segundos
    setTimeout(() => {
      window.location.href = '/exito.html'; // Cambia por tu URL de éxito
    }, 2000);
  })
  .catch(error => {
    console.error('Error en la subida:', error);
    
    // Mostrar mensaje de error más específico
    let mensajeError = 'Ocurrió un error al subir el juego.';
    
    if (error.message.includes('Failed to fetch')) {
      mensajeError = 'No se pudo conectar con el servidor. Verifica tu conexión a internet.';
    } else if (error.message.includes('NetworkError')) {
      mensajeError = 'Error de red. Verifica tu conexión a internet.';
    } else if (error.message.includes('CORS')) {
      mensajeError = 'Error de CORS. El servidor no permite solicitudes desde este origen.';
    } else {
      mensajeError = error.message || mensajeError;
    }
    
    alert(mensajeError);
  })
  .finally(() => {
    // Restaurar botón
    if (boton) {
      boton.disabled = false;
      boton.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Publicar Juego';
    }
  });
}

// Función auxiliar para mostrar errores de formulario
function mostrarError(campo, mensaje) {
  const elemento = document.getElementById(campo);
  if (elemento) {
    elemento.style.borderColor = 'red';
    
    // Crear o actualizar mensaje de error
    let errorElement = document.getElementById(`${campo}-error`);
    if (!errorElement) {
      errorElement = document.createElement('div');
      errorElement.id = `${campo}-error`;
      errorElement.style.color = 'red';
      errorElement.style.fontSize = '0.9em';
      errorElement.style.marginTop = '5px';
      elemento.parentNode.appendChild(errorElement);
    }
    
    errorElement.textContent = mensaje;
  }
}

// Función auxiliar para limpiar errores
function limpiarErrores() {
  document.querySelectorAll('[id$="-error"]').forEach(el => el.remove());
  document.querySelectorAll('.form-input, .form-select, .form-file').forEach(el => {
    el.style.borderColor = '';
  });
}

// Funciones globales para usar en onclick de HTML (si es necesario)
function openMediaFireModal() {
  abrirModalMediaFire();
}

function closeMediaFireModal() {
  cerrarModalMediaFire();
}

function saveMediaFireLink() {
  guardarEnlaceMediaFire();
}
</script>
