<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foro de Desarrolladores</title>
  <link rel="stylesheet" href="estilos.css">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../src/footer.css">
    <link rel="stylesheet" href="../src/index.css">
    <link rel="stylesheet" href="../src/nav.css">
    <link rel="stylesheet" href="../src/chat comunidad.css">
    <style>

    </style>
</head>
<body>
<nav class="navbar">
    <!-- Sección Izquierda: Logo -->
    <div class="navbar-logo">
        <img src="../assets/img/logo.png" alt="Logo de TakumiNet">
    </div>

    <!-- Sección Central: Enlaces de navegación -->
    <ul class="nav-links">
      <li><a href="index.html" class="active" aria-current="page"><i class="fas fa-home"></i> <span data-i18n="inicio">Inicio</span></a></li>
      <li><a href="marketplace.html"><i class="fas fa-store"></i> <span data-i18n="tienda">Tienda</span></a></li>
      <li><a href="game jam.html"><i class="fas fa-calendar-alt"></i> <span data-i18n="game_jams">Game Jams</span></a></li>
      <li><a href="centro-aprendiz.html"><i class="fas fa-graduation-cap"></i> <span data-i18n="tutoriales">Tutoriales</span></a></li>
      <li><a href="ranking.html"><i class="fas fa-newspaper"></i> <span data-i18n="Noticias">Noticias</span></a></li>
      <li><a href="comunidad.html"><i class="fas fa-users"></i> <span data-i18n="comunidad">Comunidad</span></a></li>
    </ul>

    <!-- Sección Derecha: Elementos interactivos -->
    <div class="nav-right">
      <!-- Búsqueda -->
      <form class="search-box" role="search">
        <input type="search" class="search-input" placeholder="Buscar juegos, usuarios..." aria-label="Buscar en el sitio" data-i18n="buscar" data-i18n-type="placeholder">
        <button type="submit" class="search-btn" aria-label="Ejecutar búsqueda">
          <i class="fas fa-search"></i>
        </button>
      </form>

      <!-- Iconos de notificaciones -->
      <div class="nav-icons">
        <div class="notification-wrapper">
          <button class="icon-btn notification-btn" onclick="toggleNotifications()" aria-haspopup="true" aria-expanded="false" aria-label="Notificaciones">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notificationBadge" aria-live="polite">0</span>
          </button>

          <!-- Menú desplegable de notificaciones -->
          <div class="dropdown-menu notification-dropdown" id="notificationDropdown" role="menu" aria-hidden="true" style="display:none;">
            <div class="dropdown-header">
              <h4 class="dropdown-title" data-i18n="notificaciones">Notificaciones</h4>
              <button class="mark-read" id="markReadBtn" data-i18n="ver_todas">Marcar todas como leídas</button>
            </div>

            <div class="notifications-list" id="notificationsList">
              <!-- Aquí se insertarán las notificaciones dinámicamente -->
            </div>
            <div class="dropdown-footer">
              <a href="/notificaciones" class="view-all" data-i18n="ver_todas">Ver todas</a>
            </div>
          </div>
        </div>

        <!-- Carrito de compras -->
        <div class="icon-btn cart-btn" aria-label="Carrito de compras" role="button" tabindex="0" onclick="toggleCart()">
          <i class="fas fa-shopping-cart"></i>
          <span class="cart-badge" aria-live="polite">5</span>
        </div>

        <!-- Menú de usuario -->
        <div class="user-menu">
          <button class="user-profile" aria-haspopup="true" aria-expanded="false" onclick="toggleUserMenu()">
            <div class="avatar">
              <i class="fas fa-user"></i>
            </div>
            <span class="username" id="mostrarNombre">Invitado</span>
          </button>

          <!-- Menú desplegable de usuario -->
          <div class="user-dropdown" id="userDropdown" role="menu" aria-hidden="true">
            <div class="dropdown-group">
              <a href="perfil del usuario.html" class="menu-item"><i class="fas fa-user"></i><span data-i18n="perfil">Perfil</span></a>
              <a href="mis juegos.html" class="menu-item"><i class="fas fa-gamepad"></i><span data-i18n="mis_juegos">Mis Juegos</span></a>
              <a href="juegos favoritos.html" class="menu-item"><i class="fas fa-heart"></i><span data-i18n="favoritos">Favoritos</span></a>
              <a href="Creator Dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i><span data-i18n="dashboard">Dashboard</span></a>
              <a href="subir_juegos.html" class="menu-item"><i class="fas fa-upload"></i><span data-i18n="subir_juego">Subir Juego</span></a>
            </div>
            <div class="dropdown-group">
              <a href="biblioteca.html" class="menu-item"><i class="fas fa-book"></i><span data-i18n="biblioteca">Biblioteca</span></a>
              <a href="descarga.html" class="menu-item"><i class="fas fa-download"></i><span data-i18n="descargas">Descargas</span></a>
            </div>
            <hr class="divider">
            <div class="dropdown-group">
              <a href="configuracion.html" class="menu-item"><i class="fas fa-cog"></i><span data-i18n="configuracion">Configuración</span></a>
              <a href="perfil-editar.html" class="menu-item"><i class="fas fa-user-edit"></i><span data-i18n="editar_usuario">Editar Usuario</span></a>
                <a href="pagos-desarrollador.html" class="menu-item"><i class="fas fa-money-bill-wave"></i><span data-i18n="pagos">Pagos</span></a>
              <a href="seguidos.html" class="menu-item"><i class="fas fa-heart"></i><span data-i18n="seguidos">Seguidos</span></a>
            </div>
            <hr class="divider">
            <div class="dropdown-group">
              <button class="menu-item logout"><i class="fas fa-sign-out-alt"></i><span data-i18n="cerrar_sesion">Cerrar Sesión</span></button>
            </div>
          </div>
        </div>
      </div>
    </div>
</nav>

<!-- HTML -->
<div class="foro-container">
  <div class="foro-header">
    <img id="foroImagen" class="foro-img" alt="Imagen del foro">

    <div class="foro-title-area">
      <h1 id="foroTitulo" class="foro-title"></h1>

      <div class="foro-meta">
        Publicado en la categoría: <strong id="foroCategoria"></strong>
        <div class="domain-wrapper">
        </div>
        Fecha: <span id="foroFecha"></span>
      </div>
    </div>
  </div>

  <div id="foroDescripcion" class="foro-description"></div>

  <div class="foro-etiquetas">
    <strong>Etiquetas:</strong>
    <div id="foroEtiquetas"></div>
  </div>
</div>

 <div class="tab-bar">
  <button class="tab-btn active" onclick="mostrarSeccion(event, 'capturas')" data-i18n="tabs.capturas">Capturas</button>
  <button class="tab-btn" onclick="mostrarSeccion(event, 'chat')" data-i18n="tabs.chat">Chat</button>
  <button class="tab-btn" onclick="mostrarSeccion(event, 'videos')" data-i18n="tabs.videos">Videos</button>
  <button class="tab-btn" onclick="mostrarSeccion(event, 'guias')" data-i18n="tabs.guias">Guías</button>
  <button class="tab-btn" onclick="mostrarSeccion(event, 'resenas')" data-i18n="tabs.resenas">Reseñas</button>
</div>


<div class="secciones">
  <!-- Sección Capturas -->
  <div id="capturas" class="seccion activa">
    <form id="formCaptura">
      <input type="file" id="inputImagen" accept="image/*" required>
      <button type="submit" data-i18n="sections.uploadImage">Subir Imagen</button>
    </form>
    <div id="galeriaCapturas"></div>
  </div>

  <!-- Sección Chat -->
  <div id="chat" class="seccion">
    <form id="formChat">
      <input type="text" id="chatMensaje" placeholder="Escribe un mensaje..." data-i18n-placeholder="sections.writeMessage" required>
      <button type="submit" data-i18n="sections.send">Enviar</button>
    </form>
    <div id="mensajesChat"></div>
  </div>

  <!-- Sección Videos -->
  <div id="videos" class="seccion">
    <form id="formVideo">
      <input type="text" id="urlVideo" placeholder="URL de video de YouTube" data-i18n-placeholder="sections.videoUrl" required>
      <button type="submit" data-i18n="sections.addVideo">Agregar Video</button>
    </form>
    <div id="listaVideos"></div>
  </div>

  <!-- Sección Guías -->
  <div id="guias" class="seccion">
    <form id="formGuia">
      <input type="text" id="tituloGuia" placeholder="Título de la guía" data-i18n-placeholder="sections.guideTitle" required>
      <textarea id="contenidoGuia" placeholder="Escribe los pasos o la explicación..." data-i18n-placeholder="sections.guideContent" rows="5" required></textarea>
      <button type="submit" data-i18n="sections.publishGuide">Publicar Guía</button>
    </form>
    <div id="listaGuias"></div>
  </div>

  <!-- Sección Reseñas -->
  <div id="resenas" class="seccion">
    <form id="formResena">
      <textarea id="textoResena" placeholder="Escribe tu opinión sobre el juego..." data-i18n-placeholder="sections.reviewPlaceholder" rows="4" required></textarea>

      <label for="calificacionResena" data-i18n="sections.rating">Calificación:</label>
      <select id="calificacionResena" required>
        <option value="5">★★★★★</option>
        <option value="4">★★★★</option>
        <option value="3">★★★</option>
        <option value="2">★★</option>
        <option value="1">★</option>
      </select>

      <button type="submit" data-i18n="sections.publishReview">Publicar Reseña</button>
    </form>

    <div id="promedioVotos" data-i18n="sections.averageRating">⭐ Promedio: 0.0 (0 votos)</div>
    <div id="listaResenas"></div>
  </div>
</div>




  

  <!-- Scripts adicionales -->
  <script src="../js/notificacion.js"></script>
  <script src="../js/carrito.js"></script>
  <script src="../js/user.js"></script>
  <script src="../js/desplegar.js"></script>
  <script src="../js/cerrar sesion.js"></script>
  <script src="../js/i18n.js"></script>
  <script src="../js/usario.js"></script>
  <script src="../js/mostrarSeccion.js"></script>
  <script src="../autoSync.js"></script>
  <script src="../script.js"></script>
  
  <!-- Asegúrate de incluir aquí también el script de comentarios/chat en tiempo real -->

</body>
</html>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  const API_BASE = "http://localhost:3001";

  function obtenerIdDesdeURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('id');
  }

  // Obtener usuario desde localStorage
  function getLocalUser() {
    const data = localStorage.getItem('takumi_user');
    if (!data) return null;
    try {
      return JSON.parse(data);
    } catch {
      return null;
    }
  }

  // Obtener usuario desde backend por ID
  async function getUserFromBackend(id) {
    try {
      const res = await fetch(`${API_BASE}/api/usuario/${id}`);
      if (!res.ok) return null;
      const data = await res.json();
      return data.ok ? data : null;
    } catch {
      return null;
    }
  }

  // Mostrar autor en el DOM
  function mostrarAutor(nombre) {
    const el = document.getElementById('foroAutor');
    if (el) {
      el.textContent = nombre || "Autor desconocido";
    } else {
      console.warn("⚠ No se encontró el elemento #foroAutor en el DOM.");
    }
  }

  // Mostrar usuario local en user-domain
  function mostrarUsuarioLocal() {
    const userDomain = document.getElementById('user-domain');
    if (!userDomain) return;

    const localUser = getLocalUser();
    userDomain.textContent = localUser?.username || 'Invitado';
  }

  mostrarUsuarioLocal();

  const foroId = obtenerIdDesdeURL();
  if (!foroId) {
    console.warn('No se especificó ID de foro en la URL');
    document.querySelector('.foro-container').innerHTML = '<p>ID de foro no especificado.</p>';
    return;
  }

  try {
    // Obtener datos del foro
    const resForo = await fetch(`${API_BASE}/foros/${encodeURIComponent(foroId)}`);
    if (!resForo.ok) throw new Error('Foro no encontrado');
    const foro = await resForo.json();

    // Mostrar datos básicos del foro
    document.getElementById('foroTitulo').textContent = foro.title || 'Sin título';
    document.getElementById('foroCategoria').textContent = foro.category || 'Sin categoría';
    document.getElementById('foroDescripcion').textContent = foro.description || 'Sin descripción';
    document.getElementById('foroFecha').textContent = foro.created_at
      ? new Date(foro.created_at).toLocaleDateString()
      : 'Fecha no disponible';

    const foroImagen = document.getElementById('foroImagen');
    foroImagen.src = foro.image_base64
      ? (foro.image_base64.startsWith('data:')
          ? foro.image_base64
          : `data:image/jpeg;base64,${foro.image_base64}`)
      : 'default-image.jpg';

    // Mostrar etiquetas
    const foroEtiquetas = document.getElementById('foroEtiquetas');
    foroEtiquetas.innerHTML = ''; // limpiar antes

    if (foro.tags) {
      // Puede ser array o string separado por comas
      const tagsArray = Array.isArray(foro.tags) ? foro.tags : foro.tags.split(',').map(t => t.trim());
      if (tagsArray.length) {
        tagsArray.forEach(tag => {
          const span = document.createElement('span');
          span.classList.add('foro-tag');
          span.textContent = tag;
          foroEtiquetas.appendChild(span);
        });
      } else {
        foroEtiquetas.textContent = 'No hay etiquetas';
      }
    } else {
      foroEtiquetas.textContent = 'No hay etiquetas';
    }

    // Mostrar autor
    const localUser = getLocalUser();
    if (localUser && foro.authorId && String(localUser.id) === String(foro.authorId)) {
      mostrarAutor(localUser.username || "Autor desconocido");
    } else if (foro.authorId) {
      const backendUser = await getUserFromBackend(foro.authorId);
      mostrarAutor(backendUser?.username || foro.author || "Autor desconocido");
    } else {
      mostrarAutor(foro.author || "Autor desconocido");
    }

  } catch (err) {
    console.error('Error al cargar foro:', err);
    document.querySelector('.foro-container').innerHTML = '<p>Foro no encontrado o error al cargar.</p>';
  }
});

</script>
